# Combined Dockerfile for Builder (Rust) + Assembly (Rust) + Embedding Worker (Python) + Generation Worker (Python)
# Runs all services in one container for simplified deployment

# Stage 1: Build the Rust applications
FROM rust:1.83 as rust-builder

WORKDIR /app

# Copy Rust workspace files
COPY Cargo.toml Cargo.lock rust-toolchain.toml ./
COPY crates/ crates/
COPY builder/Cargo.toml builder/
COPY builder/src/ builder/src/

# Build both Rust binaries in release mode
RUN cargo build --release --bin builder --bin assembly-server

# Stage 2: Final runtime image with all services
FROM python:3.11-slim

WORKDIR /app

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy Rust binaries
COPY --from=rust-builder /app/target/release/builder /app/builder
COPY --from=rust-builder /app/target/release/assembly-server /app/assembly-server

# Copy embedding worker
COPY workers/embedding/app/ /app/embedding/app/
COPY workers/embedding/pyproject.toml /app/embedding/

# Copy generation worker
COPY workers/generation/app/ /app/generation/app/
COPY workers/generation/pyproject.toml /app/generation/

# Copy ONNX model
COPY models/minilm-l6/ /app/models/minilm-l6/

# Install Python dependencies for both workers
# Install psutil first (requires build tools) then install both workers
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir psutil && \
    cd /app/embedding && \
    pip install --no-cache-dir -e . && \
    cd /app/generation && \
    pip install --no-cache-dir -e .

# Set environment variables
ENV PRODUCTION=true
ENV HOST=0.0.0.0
ENV EMBEDDING_HOST=0.0.0.0
ENV EMBEDDING_PORT=8000
ENV EMBEDDING_MODEL_PATH=/app/models/minilm-l6
ENV ASSEMBLY_HOST=0.0.0.0
ENV ASSEMBLY_PORT=8002
ENV GENERATION_HOST=0.0.0.0
ENV GENERATION_PORT=8003
ENV MODEL_NAME=gpt-5-nano

# Expose all ports
# 3000: Builder API
# 8000: Embedding Worker
# 8002: Assembly Worker
# 8003: Generation Worker
EXPOSE 3000 8000 8002 8003

# Health check for all services
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
  CMD curl -f http://localhost:3000/health && \
      curl -f http://localhost:8000/health && \
      curl -f http://localhost:8002/health && \
      curl -f http://localhost:8003/health || exit 1

# Start script to run both services
COPY start-combined.sh /app/start-combined.sh
RUN chmod +x /app/start-combined.sh

CMD ["/app/start-combined.sh"]
